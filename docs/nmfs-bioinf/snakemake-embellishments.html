<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>con-gen-csu - 13&nbsp; Important Snakemake Embellishments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../nmfs-bioinf/variant-calling.html" rel="next">
<link href="../nmfs-bioinf/snakemake-relevant-python.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../nmfs-bioinf/snakemake-embellishments.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Important Snakemake Embellishments</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../nmfs-bioinf/quarto-static/fisheries_header_logo_jul2019.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">con-gen-csu</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/eriqande/con-gen-csu" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/open-on-demand-alpine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">OpenOnDemand on Alpine</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/quick-unix-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Quick Unix Review</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/shell-prog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Shell Programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/awk-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">A Brief <code>awk</code> Intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/scripts-and-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bash scripts and functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Sedna and SLURM intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sbatch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Submitting jobs with <code>sbatch</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sequence-alignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Sequence alignment and handling BAM files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/bioinf-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Bioinformatic file formats</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snake.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Snakemake Narrative and Topics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snakemake-relevant-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Snakemake-relevant Python for R Users</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snakemake-embellishments.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Important Snakemake Embellishments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/variant-calling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Variant calling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/handling-vcf-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Basic Handling of VCF files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sfs-fst.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Estimating Site Frequency Spectra and a few applications thereof</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/mega-post.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Exploring and Using the <code>mega-post-bcf-exploratory-snakeflows</code></span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#running-snakemake-on-a-cluster-resources-profiles-and-benchmarks" id="toc-running-snakemake-on-a-cluster-resources-profiles-and-benchmarks" class="nav-link active" data-scroll-target="#running-snakemake-on-a-cluster-resources-profiles-and-benchmarks"><span class="header-section-number">13.1</span> Running Snakemake on a Cluster: resources, profiles, and benchmarks</a>
  <ul class="collapse">
  <li><a href="#specify-the-resources-required-for-each-rule" id="toc-specify-the-resources-required-for-each-rule" class="nav-link" data-scroll-target="#specify-the-resources-required-for-each-rule"><span class="header-section-number">13.1.1</span> Specify the resources required for each rule</a></li>
  <li><a href="#snakemake-profiles" id="toc-snakemake-profiles" class="nav-link" data-scroll-target="#snakemake-profiles"><span class="header-section-number">13.1.2</span> Snakemake profiles</a></li>
  <li><a href="#an-alpine-slurm-profile-for-snakemake" id="toc-an-alpine-slurm-profile-for-snakemake" class="nav-link" data-scroll-target="#an-alpine-slurm-profile-for-snakemake"><span class="header-section-number">13.1.3</span> An Alpine Slurm Profile for Snakemake</a></li>
  <li><a href="#simple-slurm-smk-profile-for-snakemake-versions-8.0" id="toc-simple-slurm-smk-profile-for-snakemake-versions-8.0" class="nav-link" data-scroll-target="#simple-slurm-smk-profile-for-snakemake-versions-8.0"><span class="header-section-number">13.1.4</span> Simple-slurm-smk profile for Snakemake versions &lt; 8.0</a></li>
  <li><a href="#the-officially-supported-slurm-executor-approach-for-snakemake-8.0" id="toc-the-officially-supported-slurm-executor-approach-for-snakemake-8.0" class="nav-link" data-scroll-target="#the-officially-supported-slurm-executor-approach-for-snakemake-8.0"><span class="header-section-number">13.1.5</span> The officially supported slurm executor approach for Snakemake &gt;= 8.0</a></li>
  <li><a href="#a-note-on-local-rules" id="toc-a-note-on-local-rules" class="nav-link" data-scroll-target="#a-note-on-local-rules"><span class="header-section-number">13.1.6</span> A note on local rules</a></li>
  </ul></li>
  <li><a href="#snakemake-config-files" id="toc-snakemake-config-files" class="nav-link" data-scroll-target="#snakemake-config-files"><span class="header-section-number">13.2</span> Snakemake config files</a>
  <ul class="collapse">
  <li><a href="#yaml-configuration" id="toc-yaml-configuration" class="nav-link" data-scroll-target="#yaml-configuration"><span class="header-section-number">13.2.1</span> YAML configuration</a></li>
  <li><a href="#tabular-configuration-via-pandas" id="toc-tabular-configuration-via-pandas" class="nav-link" data-scroll-target="#tabular-configuration-via-pandas"><span class="header-section-number">13.2.2</span> Tabular configuration via pandas</a></li>
  </ul></li>
  <li><a href="#snakemake-benchmarks" id="toc-snakemake-benchmarks" class="nav-link" data-scroll-target="#snakemake-benchmarks"><span class="header-section-number">13.3</span> Snakemake benchmarks</a></li>
  <li><a href="#some-additional-snakemake-topics" id="toc-some-additional-snakemake-topics" class="nav-link" data-scroll-target="#some-additional-snakemake-topics"><span class="header-section-number">13.4</span> Some additional snakemake topics</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/eriqande/con-gen-csu/edit/main/nmfs-bioinf/snakemake-embellishments.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/eriqande/con-gen-csu/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Important Snakemake Embellishments</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Thus far we have only scratched the surface of what Snakemake can do, and it could take a lifetime to realize the full potential of Snakemake as a workflow management system. At this point, we will point out that there is comprehensive documentation about how to use snakemake at <a href="https://snakemake.readthedocs.io/en/stable/">https://snakemake.readthedocs.io/en/stable/</a>. It is worth giving that a good-faith read-through at some point. However, it is not always clear which of the many gems in that documentation will be the most valuable for your bioinoformatic life.</p>
<p>Here we present a few embellishments upon what we have already learned that will really let you get a lot more out of Snakemake. There are three broad categories that will be discussed in different sections of this chapter.</p>
<ol type="1">
<li><p>Embellishments critical for <strong>running Snakemake on a cluster</strong>. This includes the declaration of <strong>resources</strong> required for the jobs and also the use of <strong>profiles</strong> to create a snakemake command line that can send jobs to SLURM and also communicate with SLURM to check up on jobs while they are running. It also includes telling snakemake to generate <strong>benchmark</strong> information to record how much memory and time was required for every job in your workflow—this is super handy for predicting resource requirements for future data sets!</p></li>
<li><p>Embellishments that make it easy to run your workflow on a different set of data, or a different species, or using different settings, options, or parameter values for some of the tasks/rules. The main improvement here is using snakemake <strong>config files</strong>, so that all the different settings and options for your workflow can be specified and stored and reviewed in one place. We will also see that configuration files can be very helpful for setting resource requirements for rules, which means that you only have to change things in one small config file to run your workflow on a different cluster with different partition names and machine capabilities, for example.</p></li>
<li><p>More advanced processing of wildcards using snakemake <strong>input functions</strong>. This allows your rules to react to the wildcard values in very general ways, rather than just by substituting the values into input or log file paths.</p></li>
</ol>
<section id="running-snakemake-on-a-cluster-resources-profiles-and-benchmarks" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="running-snakemake-on-a-cluster-resources-profiles-and-benchmarks"><span class="header-section-number">13.1</span> Running Snakemake on a Cluster: resources, profiles, and benchmarks</h2>
<section id="specify-the-resources-required-for-each-rule" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="specify-the-resources-required-for-each-rule"><span class="header-section-number">13.1.1</span> Specify the resources required for each rule</h3>
<p>Recall from our discussion of SLURM that the main axes upon which you will need to think about allocating computing resources for your bioinformatic jobs are:</p>
<ul>
<li><strong>Memory</strong>: what is the maximum amount of RAM the job will need while running?</li>
<li><strong>Time</strong>: How long must the job run?</li>
<li><strong>Cores</strong>: how many CPUs do you want to allocate to the job?</li>
</ul>
<p>An additional resource that Snakemake might be concerned about is <strong><code>tmpdir</code></strong> the location of a directory for writing temporary files. Typically these files get written to a directory called /tmp on the hard drive that is local to the node that the job is running on. However, at least last summer, we found that we were often exceeding the amount of space that we were offered in <code>/tmp</code> on Alpine, so we will show you how to instruct snakemake to write temporary files into a directory in the results directory on scratch.</p>
<p>Within your Snakefile, you can specify the memory and/or time resources for each rule in a <code>resources</code> block for that rule. For example, if we wanted 6 GB of memory and 10 hours for our <code>map_reads</code> rule, then we would add a <strong>resources block</strong> so that it looks like:</p>
<div class="cell" data-source-line-numbers="11-13">
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="11-13" data-code-line-numbers="11-13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>rule map_reads:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">input</span>:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    r1<span class="op">=</span><span class="st">"results/trimmed/</span><span class="sc">{sample}</span><span class="st">_R1.fastq.gz"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    r2<span class="op">=</span><span class="st">"results/trimmed/</span><span class="sc">{sample}</span><span class="st">_R2.fastq.gz"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    genome<span class="op">=</span><span class="st">"resources/genome.fasta"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    idx<span class="op">=</span>multiext(<span class="st">"resources/genome.fasta"</span>, <span class="st">".0123"</span>, <span class="st">".amb"</span>, <span class="st">".ann"</span>, <span class="st">".bwt.2bit.64"</span>, <span class="st">".pac"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"results/bam/{sample}.bam"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  conda:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"envs/bwa2sam.yaml"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  resources:</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    mem_mb<span class="op">=</span><span class="dv">6000</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    time<span class="op">=</span><span class="st">"08:00:00"</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  log:</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"results/logs/map_reads/{sample}.log"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  params:</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    RG<span class="op">=</span><span class="st">"-R '@RG</span><span class="ch">\\</span><span class="st">tID:</span><span class="sc">{sample}</span><span class="ch">\\</span><span class="st">tSM:</span><span class="sc">{sample}</span><span class="ch">\\</span><span class="st">tPL:ILLUMINA' "</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  shell:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">" (bwa-mem2 mem {params.RG} {input.genome} {input.r1} {input.r2} | "</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">" samtools view -u | "</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">" samtools sort - &gt; {output}) 2&gt; {log} "</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the above, we have named and specified our resources the way SLURM would.</p>
<p>Additionally, if for most of our rules we simply wanted a <em>default</em> time of 4 hours and a <em>default</em> amount of 3.74 Gb of memory, we don’t have to write a resources block for each of those rules. Rather, we could just specify that on the command line with the <code>--default-resources</code> option, like this:</p>
<div class="sourceCode" id="cb2" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--default-resources</span>  mem_mb=3.74  time=<span class="st">"04:00:00"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That is handy if most of your rules require the same resources.</p>
<p>We have not yet discussed how to request a certain number of cores/CPUs for each job of a rule. Remember, there is no point of requesting more cores/CPUs than the number of threads that can be used by the programs running the job. Consequently, you want the number of cores/CPUs to typically be set to the number of threads that the program(s) in your job are using. As a consequence, CPUs are typically set according to the <code>threads</code> specifier in the Snakemake rule. We haven’t talked about this yet, but it is simple—you set an integer value in a <code>threads</code> block, then you can use <code>{threads}</code> in the shell block to tell the program how many threads to use.</p>
<p>We will again illustrate this with our <code>map_reads</code> rule. <code>bwa-mem2 mem</code> uses the <code>-t</code> option to specify the number of threads to use, so, to make <code>bwa-mem2 mem</code> use 4 threads we could write:</p>
<div class="cell" data-source-line-numbers="11,13,20">
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="11,13,20" data-code-line-numbers="11,13,20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rule map_reads:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">input</span>:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    r1<span class="op">=</span><span class="st">"results/trimmed/</span><span class="sc">{sample}</span><span class="st">_R1.fastq.gz"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    r2<span class="op">=</span><span class="st">"results/trimmed/</span><span class="sc">{sample}</span><span class="st">_R2.fastq.gz"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    genome<span class="op">=</span><span class="st">"resources/genome.fasta"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    idx<span class="op">=</span>multiext(<span class="st">"resources/genome.fasta"</span>, <span class="st">".0123"</span>, <span class="st">".amb"</span>, <span class="st">".ann"</span>, <span class="st">".bwt.2bit.64"</span>, <span class="st">".pac"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  output:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"results/bam/{sample}.bam"</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  conda:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"envs/bwa2sam.yaml"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  threads: <span class="dv">4</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  resources:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    mem_mb<span class="op">=</span><span class="dv">3740</span> <span class="op">*</span> <span class="dv">4</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    time<span class="op">=</span><span class="st">"08:00:00"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  log:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"results/logs/map_reads/{sample}.log"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  params:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    RG<span class="op">=</span><span class="st">"-R '@RG</span><span class="ch">\\</span><span class="st">tID:</span><span class="sc">{sample}</span><span class="ch">\\</span><span class="st">tSM:</span><span class="sc">{sample}</span><span class="ch">\\</span><span class="st">tPL:ILLUMINA' "</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  shell:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">" (bwa-mem2 mem -t {threads} {params.RG} {input.genome} {input.r1} {input.r2} | "</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">" samtools view -u | "</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">" samtools sort - &gt; {output}) 2&gt; {log} "</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note we have specified 4 threads, and we also bumped up the memory, because if we are asking for 4 cores, we might as well get the default amount of memory (3.74 Gb, on Alpine) that we would get with each core.</p>
<p>All of that is pretty straightforward; however, doing this does not automatically cause the rule to be dispatched by SLURM and granted those resources. Rather, Snakemake must be told to send jobs to SLURM and also to use the <code>resources</code> and <code>threads</code> to appropriately request the right amount of resources from SLURM. Snakemake versions &lt; 8.0 had an older “officially sanctioned/supported” way of sending jobs to SLURM that can be found <a href="https://github.com/Snakemake-Profiles/slurm">here</a>. However, that approach is quite complex—it is implemented in a bunch of python scripts that I find hard to read, and I find it difficult to understand what all these scripts are doing.</p>
<p>Snakemake version 8.0 brought big changes, and snakemake versions &gt;= 8.0 include an <code>--executor</code> option that uses <em>snakemake-executor-plugins</em>. These offer a relatively painless way of running Snakemake with SLURM. One of the advantages of this is that you should be able to set your workflow up to run in SLURM with the SLURM snakemake executor plugin, and then, with very few changes to your workflow you should be able to also run it using Google Batch or Amazon’s Cloud compute infrastructure using a different snakemake executor plugin. That has some big advantges, but it comes at the cost of flexibility. For example, when running the official Snakemake &gt;= 8.0 SLURM executor plugin, the job names are completely meaningless and not useful at all.</p>
<p>By contrast, a different approach to having Snakemake send jobs to SLURM is implemented in the wonderfully readable and easy-to-understand approach taken by John D. Blischak, (find it <a href="https://github.com/jdblischak/smk-simple-slurm">here</a> on GitHub) John was a postdoc with Matthew Stephens and has worked extensively in improving research reproducibility. His method is implemented almost entirely by using command line options (plus one little script to help check the status of jobs in the SLURM queue). However, to avoid having to type all these options at the command line every time you launch snakemake to use SLURM, these command line options can be saved and read from a <strong>snakemake profile</strong>. We discuss profiles in the next section and show how they can be used to allow snakemake to submit jobs to SLURM. This works on both Snakemake versions &lt; 8.0 and &gt;= 8.0, but the profiles are slightly different.</p>
</section>
<section id="snakemake-profiles" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="snakemake-profiles"><span class="header-section-number">13.1.2</span> Snakemake profiles</h3>
<p>We begin this section by quickly perusing all the different command line options that can be used when launching snakemake. If we type <code>snakemake --help</code> we get a listing of all the options. It starts with a synopsis of all the options, which is followed by longer explanations of each individual option. The synopsis looks like this:</p>
<div class="sourceCode" id="cb4" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">usage:</span> snakemake <span class="pp">[-</span><span class="ss">h</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">dry</span><span class="pp">-</span><span class="ss">run</span><span class="pp">]</span> [--profile PROFILE] [--workflow-profile WORKFLOW_PROFILE] [--cache [RULE ...]] [--snakefile FILE] [--cores N]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--jobs</span> N] [--local-cores N] [--resources NAME=INT [NAME=INT ...]] [--set-threads RULE=THREADS [RULE=THREADS ...]]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--max-threads</span> MAX_THREADS] [--set-resources RULE:RESOURCE=VALUE [RULE:RESOURCE=VALUE ...]]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--set-scatter</span> NAME=SCATTERITEMS [NAME=SCATTERITEMS ...]] [--set-resource-scopes RESOURCE=[global<span class="kw">|</span><span class="ex">local]</span> [RESOURCE=[global<span class="kw">|</span><span class="ex">local]</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">...]]</span> [--default-resources [NAME=INT ...]] [--preemptible-rules [PREEMPTIBLE_RULES ...]]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--preemptible-retries</span> PREEMPTIBLE_RETRIES] [--config [KEY=VALUE ...]] [--configfile FILE [FILE ...]]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--envvars</span> VARNAME [VARNAME ...]] [--directory DIR] <span class="pp">[--</span><span class="ss">touch</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">keep</span><span class="pp">-</span><span class="ss">going</span><span class="pp">]</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--rerun-triggers</span> <span class="dt">{code</span><span class="op">,</span><span class="dt">input</span><span class="op">,</span><span class="dt">mtime</span><span class="op">,</span><span class="dt">params</span><span class="op">,</span><span class="dt">software-env}</span> [<span class="dt">{code</span><span class="op">,</span><span class="dt">input</span><span class="op">,</span><span class="dt">mtime</span><span class="op">,</span><span class="dt">params</span><span class="op">,</span><span class="dt">software-env}</span> ...]] <span class="pp">[--</span><span class="ss">force</span><span class="pp">]</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--executor</span> <span class="dt">{local</span><span class="op">,</span><span class="dt">dryrun</span><span class="op">,</span><span class="dt">touch}</span>] <span class="pp">[--</span><span class="ss">forceall</span><span class="pp">]</span> [--forcerun [TARGET ...]] [--prioritize TARGET [TARGET ...]]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--batch</span> RULE=BATCH/BATCHES] [--until TARGET [TARGET ...]] [--omit-from TARGET [TARGET ...]] <span class="pp">[--</span><span class="ss">rerun</span><span class="pp">-</span><span class="ss">incomplete</span><span class="pp">]</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--shadow-prefix</span> DIR] [--scheduler <span class="pp">[</span><span class="ss">{ilp,greedy}</span><span class="pp">]</span>] [--wms-monitor <span class="pp">[</span><span class="ss">WMS_MONITOR</span><span class="pp">]</span>] [--wms-monitor-arg [NAME=VALUE ...]]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--scheduler-ilp-solver</span> <span class="dt">{PULP_CBC_CMD</span><span class="op">,</span><span class="dt">COIN_CMD}</span>] [--scheduler-solver-path SCHEDULER_SOLVER_PATH]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--conda-base-path</span> CONDA_BASE_PATH] <span class="pp">[--</span><span class="ss">no</span><span class="pp">-</span><span class="ss">subworkflows</span><span class="pp">]</span> [--precommand PRECOMMAND] [--groups GROUPS [GROUPS ...]]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--group-components</span> GROUP_COMPONENTS [GROUP_COMPONENTS ...]] [--report <span class="pp">[</span><span class="ss">FILE</span><span class="pp">]</span>] [--report-stylesheet CSSFILE] [--reporter PLUGIN]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--draft-notebook</span> TARGET] [--edit-notebook TARGET] [--notebook-listen IP:PORT] [--lint <span class="pp">[</span><span class="ss">{text,json}</span><span class="pp">]</span>]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--generate-unit-tests</span> <span class="pp">[</span><span class="ss">TESTPATH</span><span class="pp">]</span>] <span class="pp">[--</span><span class="ss">containerize</span><span class="pp">]</span> [--export-cwl FILE] <span class="pp">[--</span><span class="ss">list</span><span class="pp">-</span><span class="ss">rules</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">list</span><span class="pp">-</span><span class="ss">target</span><span class="pp">-</span><span class="ss">rules</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">dag</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">rulegraph</span><span class="pp">]</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--filegraph]</span> <span class="pp">[--</span><span class="ss">d3dag</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">summary</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">detailed</span><span class="pp">-</span><span class="ss">summary</span><span class="pp">]</span> [--archive FILE] [--cleanup-metadata FILE [FILE ...]] <span class="pp">[--</span><span class="ss">cleanup</span><span class="pp">-</span><span class="ss">shadow</span><span class="pp">]</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--skip-script-cleanup]</span> <span class="pp">[--</span><span class="ss">unlock</span><span class="pp">]</span> [--list-changes <span class="dt">{params</span><span class="op">,</span><span class="dt">code</span><span class="op">,</span><span class="dt">input}</span>] <span class="pp">[--</span><span class="ss">list</span><span class="pp">-</span><span class="ss">input</span><span class="pp">-</span><span class="ss">changes</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">list</span><span class="pp">-</span><span class="ss">params</span><span class="pp">-</span><span class="ss">changes</span><span class="pp">]</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--list-untracked]</span> [--delete-all-output <span class="kw">|</span> <span class="ex">--delete-temp-output]</span> <span class="pp">[--</span><span class="ss">keep</span><span class="pp">-</span><span class="ss">incomplete</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">drop</span><span class="pp">-</span><span class="ss">metadata</span><span class="pp">]</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--deploy-sources</span> QUERY CHECKSUM] <span class="pp">[--</span><span class="ss">version</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">printshellcmds</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">debug</span><span class="pp">-</span><span class="ss">dag</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">nocolor</span><span class="pp">]</span> [--quiet [<span class="dt">{all</span><span class="op">,</span><span class="dt">progress</span><span class="op">,</span><span class="dt">rules}</span> ...]]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--print-compilation]</span> <span class="pp">[--</span><span class="ss">verbose</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">force</span><span class="pp">-</span><span class="ss">use</span><span class="pp">-</span><span class="ss">threads</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">allow</span><span class="pp">-</span><span class="ss">ambiguity</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">nolock</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">ignore</span><span class="pp">-</span><span class="ss">incomplete</span><span class="pp">]</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--max-inventory-time</span> SECONDS] [--latency-wait SECONDS] [--wait-for-files [FILE ...]] [--wait-for-files-file FILE]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--queue-input-wait-time</span> SECONDS] <span class="pp">[--</span><span class="ss">notemp</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">all</span><span class="pp">-</span><span class="ss">temp</span><span class="pp">]</span> [--unneeded-temp-files FILE [FILE ...]] <span class="pp">[--</span><span class="ss">keep</span><span class="pp">-</span><span class="ss">storage</span><span class="pp">-</span><span class="ss">local</span><span class="pp">-</span><span class="ss">copies</span><span class="pp">]</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--target-files-omit-workdir-adjustment]</span> [--allowed-rules ALLOWED_RULES [ALLOWED_RULES ...]]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--target-jobs</span> TARGET_JOBS [TARGET_JOBS ...]] [--local-groupid LOCAL_GROUPID] [--max-jobs-per-second MAX_JOBS_PER_SECOND]</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--max-status-checks-per-second</span> MAX_STATUS_CHECKS_PER_SECOND] [--seconds-between-status-checks SECONDS_BETWEEN_STATUS_CHECKS]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--retries</span> RETRIES] [--attempt ATTEMPT] [--wrapper-prefix WRAPPER_PREFIX] [--default-storage-provider DEFAULT_STORAGE_PROVIDER]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--default-storage-prefix</span> DEFAULT_STORAGE_PREFIX] [--local-storage-prefix LOCAL_STORAGE_PREFIX]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--shared-fs-usage</span> <span class="dt">{input-output</span><span class="op">,</span><span class="dt">persistence</span><span class="op">,</span><span class="dt">software-deployment</span><span class="op">,</span><span class="dt">source-cache</span><span class="op">,</span><span class="dt">sources</span><span class="op">,</span><span class="dt">storage-local-copies</span><span class="op">,</span><span class="dt">none}</span> [<span class="dt">{input-output</span><span class="op">,</span><span class="dt">persistence</span><span class="op">,</span><span class="dt">software-deployment</span><span class="op">,</span><span class="dt">source-cache</span><span class="op">,</span><span class="dt">sources</span><span class="op">,</span><span class="dt">storage-local-copies</span><span class="op">,</span><span class="dt">none}</span> ...]]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--scheduler-greediness</span> SCHEDULER_GREEDINESS] <span class="pp">[--</span><span class="ss">no</span><span class="pp">-</span><span class="ss">hooks</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">debug</span><span class="pp">]</span> [--runtime-profile FILE] [--mode <span class="dt">{default</span><span class="op">,</span><span class="dt">remote</span><span class="op">,</span><span class="dt">subprocess}</span>]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--show-failed-logs]</span> [--log-handler-script FILE] [--log-service <span class="dt">{none</span><span class="op">,</span><span class="dt">slack</span><span class="op">,</span><span class="dt">wms}</span>] <span class="pp">[--</span><span class="ss">job</span><span class="pp">-</span><span class="ss">deploy</span><span class="pp">-</span><span class="ss">sources</span><span class="pp">]</span> [--container-image IMAGE]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--immediate-submit]</span> [--jobscript SCRIPT] [--jobname NAME] <span class="pp">[--</span><span class="ss">flux</span><span class="pp">]</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--software-deployment-method</span> <span class="dt">{apptainer</span><span class="op">,</span><span class="dt">conda</span><span class="op">,</span><span class="dt">env-modules}</span> [<span class="dt">{apptainer</span><span class="op">,</span><span class="dt">conda</span><span class="op">,</span><span class="dt">env-modules}</span> ...]] <span class="pp">[--</span><span class="ss">container</span><span class="pp">-</span><span class="ss">cleanup</span><span class="pp">-</span><span class="ss">images</span><span class="pp">]</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--use-conda]</span> <span class="pp">[--</span><span class="ss">conda</span><span class="pp">-</span><span class="ss">not</span><span class="pp">-</span><span class="ss">block</span><span class="pp">-</span><span class="ss">search</span><span class="pp">-</span><span class="ss">path</span><span class="pp">-</span><span class="ss">envvars</span><span class="pp">]</span> <span class="pp">[--</span><span class="ss">list</span><span class="pp">-</span><span class="ss">conda</span><span class="pp">-</span><span class="ss">envs</span><span class="pp">]</span> [--conda-prefix DIR] <span class="pp">[--</span><span class="ss">conda</span><span class="pp">-</span><span class="ss">cleanup</span><span class="pp">-</span><span class="ss">envs</span><span class="pp">]</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--conda-cleanup-pkgs</span> <span class="pp">[</span><span class="ss">{tarballs,cache}</span><span class="pp">]</span>] <span class="pp">[--</span><span class="ss">conda</span><span class="pp">-</span><span class="ss">create</span><span class="pp">-</span><span class="ss">envs</span><span class="pp">-</span><span class="ss">only</span><span class="pp">]</span> [--conda-frontend <span class="dt">{conda</span><span class="op">,</span><span class="dt">mamba}</span>] <span class="pp">[--</span><span class="ss">use</span><span class="pp">-</span><span class="ss">apptainer</span><span class="pp">]</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--apptainer-prefix</span> DIR] [--apptainer-args ARGS] <span class="pp">[--</span><span class="ss">use</span><span class="pp">-</span><span class="ss">envmodules</span><span class="pp">]</span> [--report-html-path VALUE]</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[--report-html-stylesheet-path</span> VALUE]</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">[targets</span> ...]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this synopsis, command line options that are truly optional (which is basically all of them!) are wrapped in <code>[ ]</code>. You will notice that some of these options, like <code>--dry-run</code> (look at the top line of the synopsis) do not take any arguments (there is nothing after <code>--dry-run</code> in the <code>[ ]</code>), while other options, like <code>--profile</code> take an argument, in the above listing, of <code>PROFILE</code>. Clearly if you use even a small fraction of these optional command-line options to snakemake, the stuff you type on the command line could grow long, typing it in on the command line could become quite ponderous, and the chance to make a mistake would grow, the longer the command line got. Not only that, but if you were just putting these options on the command line, it would be easy to forget exactly which options you used!</p>
<p>This is where snakemake profiles come in. A snakemake profile is a collection of files in a directory, one of which is named <code>config.yaml</code>. So, if I have directory <code>./my-profile</code> and within that a file <code>./my-profile/config.yaml</code>, then, I can store the command line options I want to use in YAML format in <code>./my-profile/config.yaml</code> and those options will be added to the command line if I invoke snakemake with:</p>
<div class="sourceCode" id="cb5" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> ./my-profile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that it is good practice to add the <code>.</code> in front of your profile name, because otherwise Snakemake might search for system-wide or user-wide profiles.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Profiles for versions &lt; 8.0 and &gt;= 8.0
</div>
</div>
<div class="callout-body-container callout-body">
<p>The changes introduced in Snakemake version 8.0 were large enough that older profiles might not run on versions &gt;= 8.0 and profiles meant for versions &gt;= 8.0 might not run on versions &lt; 8.0. To handle this, Snakemake’s developers allow for there to be two config files withing the profile directory. In our repo, for example:</p>
<div class="sourceCode" id="cb6" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Snakemake-Example/slurm/jdb</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> alpine</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> ├── config.v8+.yaml</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> ├── config.yaml</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> └── status-sacct-robust.sh</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> sedna</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">├──</span> config.v8+.yaml</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">├──</span> config.yaml</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└──</span> status-sacct-robust.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is a <code>config.v8+.yaml</code> and a <code>config.yaml</code> in these profile directories for alpine and sedna. Snakemake Version &gt;= 8.0 will preferentially use the <code>config.v8+.yaml</code> file, and versions of Snakemake &lt; 8.0 will use <code>config.yaml</code> because they don’t even recognize <code>config.v8+.yaml</code>.</p>
</div>
</div>
<p>So, how do you write command line options in the YAML-formatted Snakemake profile <code>config.yaml</code>? It is easy:</p>
<ul>
<li><p>You can specify any command line option that is preceded by two dashes, like <code>--option</code>, but you cannot specify options that you might specify with a single dash, like <code>-n</code> or <code>-p</code> (or <code>-np</code> as we often type the two together). This is OK, because every single-dash option has a two-dash name. For example:</p>
<ul>
<li><code>-n</code> is the same as <code>--dry-run</code></li>
<li><code>-p</code> is the same as <code>--printshellcmds</code></li>
<li><code>-v</code> is the same as <code>--version</code> and so forth.</li>
</ul></li>
<li><p>If the option <strong>does not</strong> take an argument, for example <code>--dry-run</code> or <code>--printshellcmds</code>, then you enter them into the <code>config.yaml</code> file by writing the option name, <em>without the dashes</em>, following it with a colon and then a space and then <code>True</code>, like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dry-run</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>If the option <strong>does</strong> take an argument, for example <code>--cores 20</code> or <code>--rerun-triggers mtime</code>, then you just include the argument after the colon (and a space), like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cores</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rerun-triggers</span><span class="kw">:</span><span class="at"> mtime</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
<p>And that is all there is to it!</p>
</section>
<section id="an-alpine-slurm-profile-for-snakemake" class="level3" data-number="13.1.3">
<h3 data-number="13.1.3" class="anchored" data-anchor-id="an-alpine-slurm-profile-for-snakemake"><span class="header-section-number">13.1.3</span> An Alpine Slurm Profile for Snakemake</h3>
<p>If you are using Snakemake &gt;= 8.0, you have to do one step to get the JDB’s simple-slurm-smk config to work:</p>
<div class="sourceCode" id="cb9" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install snakemake-executor-plugin-cluster-generic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Do not do that if you are using Snakemake versions &lt; 8.0.</p>
<p>We have a profile for sending jobs to Alpine in the directory <code>Snakemake-Example/slurm/jdb/alpine</code>. The <code>config.v8+.yaml</code> file within that looks like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Snakemake-Example/slurm/jdb/alpine/config.v8+.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> cluster-generic</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cluster-generic-submit-cmd</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">  mkdir -p results/slurm_logs/{rule} &amp;&amp;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">  sbatch</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="at">    --partition=amilan,csu</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="at">    --cpus-per-task={threads}</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="at">    --mem={resources.mem_mb}</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">    --time={resources.time}</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="at">    --job-name=smk-{rule}-{wildcards}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="at">    --output=results/slurm_logs/{rule}/{rule}-%j-{wildcards}.out</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="at">    --error=results/slurm_logs/{rule}/{rule}-%j-{wildcards}.err</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="at">    --parsable</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cluster-generic-status-cmd</span><span class="kw">:</span><span class="at"> status-sacct-robust.sh</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cluster-generic-cancel-cmd</span><span class="kw">:</span><span class="at"> scancel</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cluster-generic-cancel-nargs</span><span class="kw">:</span><span class="at"> </span><span class="dv">400</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># warning, time here is very small.  It works for the small</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># example data set, but should be increased for production jobs</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> time="00:30:00"</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb=3740</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> tmpdir="results/snake-tmp"</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">restart-times</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="fu">max-jobs-per-second</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="fu">max-status-checks-per-second</span><span class="kw">:</span><span class="at"> </span><span class="dv">25</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="fu">local-cores</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="fu">latency-wait</span><span class="kw">:</span><span class="at"> </span><span class="dv">60</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cores</span><span class="kw">:</span><span class="at"> </span><span class="dv">2400</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">950</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="fu">keep-going</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="fu">rerun-incomplete</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="fu">software-deployment-method</span><span class="kw">:</span><span class="at"> conda</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="fu">rerun-trigger</span><span class="kw">:</span><span class="at"> mtime</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We see here that the “heavy-lifting” is done by snakemake’s <code>--cluster-generic-submit-cmd</code> option. This option takes as an argument a command line that should be used to send off individual jobs for execution. As you can see, the command it uses does two main things:</p>
<ol type="1">
<li>First it creates a directory in which to place the <code>error</code> and <code>output</code> files that <code>sbatch</code> will write.</li>
<li>If that first command is successful, it then runs <code>sbatch</code> with a variety of options.</li>
</ol>
<p>Various values known to snakemake can be substituted into that <code>sbatch</code> command line by enclosing them within curly braces, thereby passing them as arguments to various <code>sbatch</code> options. In particular:</p>
<ul>
<li><code>{rule}</code> expands into the rule name</li>
<li><code>{threads}</code> expands into the number of threads to be used for the rule</li>
<li><code>{wildcards}</code> expands into a comma-separate string with the values of the wildcards in effect for this job, like <code>sample=A,chromo=NC103567.1</code></li>
<li><code>{resources.mem_mb}</code> and <code>{resources.time}</code> print the values given for <code>mem_mb</code> and <code>time</code> in the <code>resources:</code> block of the rule.</li>
</ul>
<p>Each of these values are used as arguments to different <code>sbatch</code> options in a plainly readable way. The last option given is <code>--parsable</code> which tells <code>sbatch</code> to return the job number of the submitted job in an easily parsable fashion.</p>
<p>Snakemake takes this <code>sbatch</code> command and uses it to submit a job script. Snakemake itself writes that job script (and stores it in the <code>.snakemake</code> directory for as long as it is needed) according to the code that it finds in the <code>shell</code> block of the rule. This is why you never need to write another <code>sbatch</code> script in your life if you use snakemake—Snakemake writes those scripts for you and submits them via <code>sbatch</code>.</p>
<p>You will also notice that the profile defines the <code>--default-resources</code> option that we described above. Note that the default memory is 3740, which is what you get with one core on Alpine, and the default time is 8 hours.</p>
<p>Some of the remaining options in the profile are not really specific to SLURM, but many are. One of those,</p>
<div class="sourceCode" id="cb11" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cluster-generic-status-cmd</span><span class="kw">:</span><span class="at"> status-sacct-robust.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>gives the name of a shell script <em>in the profile directory</em> that snakemake uses to check on the status of jobs that have been submitted to the cluster. This is a script that queries SLURM using <code>sacct</code> to ask about the status of running jobs according to their job number. For each job, the script tells Snakemake either:</p>
<ul>
<li><code>success</code>: the job finished successfully.</li>
<li><code>running</code>: the job is still running or waiting in the queue</li>
<li><code>failed</code>: the job failed</li>
</ul>
<p>When your jobs are running, Snakemake is continually checking on their status, but won’t check more than <code>max-status-checks-per-second</code>. (In the case of this profile that is 25 checks per second.)</p>
<p>You can unfold the following code block to see the shell code for <code>status-sacct-robust.sh</code>.</p>
<div class="cell">
<div class="code-with-filename">
<details class="code-fold">
<summary>Click the triangle to see the code</summary>
<div class="code-with-filename-file">
<pre><strong>Snakemake-Example/slurm/alpine/status-sacct-robust.sh</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check status of Slurm job. More robust because runs `sacct` multiple times if</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># needed</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="va">jobid</span><span class="op">=</span><span class="st">"</span><span class="va">$1</span><span class="st">"</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">[[</span> <span class="st">"</span><span class="va">$jobid</span><span class="st">"</span> <span class="ot">==</span> Submitted <span class="kw">]]</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> smk-simple-slurm: Invalid job ID: <span class="st">"</span><span class="va">$jobid</span><span class="st">"</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> smk-simple-slurm: Did you remember to add the flag <span class="at">--parsable</span> to your sbatch call<span class="pp">?</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> get_status()</span><span class="kw">{</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">sacct</span> <span class="at">-j</span> <span class="st">"</span><span class="va">$1</span><span class="st">"</span> <span class="at">--format</span> State <span class="at">--noheader</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 1 <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{print $1}'</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">20</span><span class="dt">}</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">output</span><span class="op">=</span><span class="kw">`</span><span class="ex">get_status</span> <span class="st">"</span><span class="va">$jobid</span><span class="st">"</span><span class="kw">`</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">[[</span> <span class="ot">!</span> <span class="ot">-z</span> <span class="va">$output</span> <span class="kw">]]</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">then</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span> 3</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">[[</span> <span class="ot">-z</span> <span class="va">$output</span> <span class="kw">]]</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> sacct failed to return the status for jobid <span class="st">"</span><span class="va">$jobid</span><span class="st">"</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> Maybe you need to use scontrol instead<span class="pp">?</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">[[</span> <span class="va">$output</span> <span class="ot">=~</span> <span class="pp">^</span><span class="op">(</span><span class="ss">COMPLETED</span><span class="op">)</span><span class="pp">.*</span> <span class="kw">]]</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> success</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="kw">[[</span> <span class="va">$output</span> <span class="ot">=~</span> <span class="pp">^</span><span class="op">(</span><span class="ss">RUNNING</span><span class="pp">|</span><span class="ss">PENDING</span><span class="pp">|</span><span class="ss">COMPLETING</span><span class="pp">|</span><span class="ss">CONFIGURING</span><span class="pp">|</span><span class="ss">SUSPENDED</span><span class="op">)</span><span class="pp">.*</span> <span class="kw">]]</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> running</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> failed</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<p>Much of the code is there to make sure the script tries at least 20 times to get the status of the job, because sometimes SLURM gets busy and fails to return a result for a job, which causes snakemake to do bad things…</p>
<p>Other SLURM-relevant options in this profile are:</p>
<ul>
<li><code>--cluster-generic-cancel-cmd</code>: if the Snakemake run is terminated (with <code>&lt;cntrl&gt;-c</code> for example) then kill all jobs running under SLURM using the <code>scancel</code> command.</li>
<li><code>--cluster-generic-cancel-nargs</code>: the maximum number of arguments to pass to <code>scancel</code> when cancelling jobs. This should be high enough to kill all jobs currently running or queued up in SLURM.<br>
</li>
<li><code>--jobs</code>: don’t submit so many jobs that you have more than this number of jobs running or waiting in the SLURM queue. This is quite important in Alpine, because SLURM on Alpine doesn’t let you have more the 1000 jobs running or queued up.<br>
</li>
<li><code>--max-jobs-per-second</code>: don’t submit more than this jobs each second to SLURM</li>
</ul>
<p>So, in summary, if you are using snakemake and you had the <code>alpine</code> directory containing <code>config.yaml</code> and <code>status-sacct-robust.sh</code> in the directory you were running snakemake from, you could get snakemake to submit jobs to the cluster using SLURM by doing:</p>
<div class="sourceCode" id="cb13" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span>  [some options or targets here] <span class="at">--profile</span> ./alpine  [other options or targets here]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Also, we will end this section by noting that you can override options in the profile by adding them actually on the command line, just like with <code>sbatch</code> and its <code>#SBATCH</code> directives.</p>
</section>
<section id="simple-slurm-smk-profile-for-snakemake-versions-8.0" class="level3" data-number="13.1.4">
<h3 data-number="13.1.4" class="anchored" data-anchor-id="simple-slurm-smk-profile-for-snakemake-versions-8.0"><span class="header-section-number">13.1.4</span> Simple-slurm-smk profile for Snakemake versions &lt; 8.0</h3>
<p>If you are running snakemake &lt; 8.0, you don’t have the executor option, and some of the command line options are a little shorter:</p>
<div class="cell">
<div class="code-with-filename">
<details class="code-fold">
<summary>Click the triangle to see the code with changes from v8+ highlighted</summary>
<div class="code-with-filename-file">
<pre><strong>Snakemake-Example/slurm/jdb/alpine/config.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>cluster:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  mkdir <span class="op">-</span>p results<span class="op">/</span>slurm_logs<span class="op">/</span>{rule} <span class="op">&amp;&amp;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  sbatch</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>partition<span class="op">=</span>amilan,csu</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>cpus<span class="op">-</span>per<span class="op">-</span>task<span class="op">=</span>{threads}</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>mem<span class="op">=</span>{resources.mem_mb}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>time<span class="op">=</span>{resources.time}</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>job<span class="op">-</span>name<span class="op">=</span>smk<span class="op">-</span>{rule}<span class="op">-</span>{wildcards}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>output<span class="op">=</span>results<span class="op">/</span>slurm_logs<span class="op">/</span>{rule}<span class="op">/</span>{rule}<span class="op">-%</span>j<span class="op">-</span>{wildcards}.out</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>error<span class="op">=</span>results<span class="op">/</span>slurm_logs<span class="op">/</span>{rule}<span class="op">/</span>{rule}<span class="op">-%</span>j<span class="op">-</span>{wildcards}.err</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>parsable</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>cluster<span class="op">-</span>status: status<span class="op">-</span>sacct<span class="op">-</span>robust.sh</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>cluster<span class="op">-</span>cancel: scancel</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>cluster<span class="op">-</span>cancel<span class="op">-</span>nargs: <span class="dv">400</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># warning, time here is very small.  It works for the small</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># example data set, but should be increased for production jobs</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>default<span class="op">-</span>resources:</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> time<span class="op">=</span><span class="st">"00:30:00"</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> mem_mb<span class="op">=</span><span class="dv">3740</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> tmpdir<span class="op">=</span><span class="st">"results/snake-tmp"</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>restart<span class="op">-</span>times: <span class="dv">0</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="bu">max</span><span class="op">-</span>jobs<span class="op">-</span>per<span class="op">-</span>second: <span class="dv">10</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="bu">max</span><span class="op">-</span>status<span class="op">-</span>checks<span class="op">-</span>per<span class="op">-</span>second: <span class="dv">25</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>local<span class="op">-</span>cores: <span class="dv">1</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>latency<span class="op">-</span>wait: <span class="dv">60</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>cores: <span class="dv">2400</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>jobs: <span class="dv">950</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>keep<span class="op">-</span>going: <span class="va">True</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>rerun<span class="op">-</span>incomplete: <span class="va">True</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>printshellcmds: <span class="va">True</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>use<span class="op">-</span>conda: <span class="va">True</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>rerun<span class="op">-</span>trigger: mtime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="the-officially-supported-slurm-executor-approach-for-snakemake-8.0" class="level3" data-number="13.1.5">
<h3 data-number="13.1.5" class="anchored" data-anchor-id="the-officially-supported-slurm-executor-approach-for-snakemake-8.0"><span class="header-section-number">13.1.5</span> The officially supported slurm executor approach for Snakemake &gt;= 8.0</h3>
<p>One must first download a snakemake-executor-plugin like this:</p>
<div class="sourceCode" id="cb15" data-code-line-numbers=""><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install snakemake-executor-plugin-slurm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After that, you can use a profile that looks like this:</p>
<div class="sourceCode" id="cb16" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=20</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb=3740</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> tmpdir="results/snake-tmp"</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">restart-times</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">max-jobs-per-second</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">max-status-checks-per-second</span><span class="kw">:</span><span class="at"> </span><span class="dv">50</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">local-cores</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">latency-wait</span><span class="kw">:</span><span class="at"> </span><span class="dv">60</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cores</span><span class="kw">:</span><span class="at"> </span><span class="dv">2400</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">950</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">keep-going</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rerun-incomplete</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">use-conda</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rerun-trigger</span><span class="kw">:</span><span class="at"> mtime</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a-note-on-local-rules" class="level3" data-number="13.1.6">
<h3 data-number="13.1.6" class="anchored" data-anchor-id="a-note-on-local-rules"><span class="header-section-number">13.1.6</span> A note on local rules</h3>
<p>You can tell Snakemake to execute rules locally by putting them in a <code>localrules:</code> directive near the top of the Snakefile, like:</p>
<div class="sourceCode" id="cb17" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">localrules</span><span class="kw">:</span><span class="at"> all, genome_faidx, genome_dict</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="snakemake-config-files" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="snakemake-config-files"><span class="header-section-number">13.2</span> Snakemake config files</h2>
<p>We have already seen that we might add some variables to our Snakefile to run a workflow on certain samples, etc.</p>
<section id="yaml-configuration" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="yaml-configuration"><span class="header-section-number">13.2.1</span> YAML configuration</h3>
<p>Helpful snippet for testing:</p>
<div class="sourceCode" id="cb18" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> snakemake.common.configfile <span class="im">import</span> _load_configfile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tabular-configuration-via-pandas" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="tabular-configuration-via-pandas"><span class="header-section-number">13.2.2</span> Tabular configuration via pandas</h3>
</section>
</section>
<section id="snakemake-benchmarks" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="snakemake-benchmarks"><span class="header-section-number">13.3</span> Snakemake benchmarks</h2>
<p>Compared the previous two topics, this is really simple.</p>
<p>Recommended convention, put them in:</p>
<pre data-code-line-numbers=""><code>results/benchmarks/&lt;rule_name&gt;/&lt;first_wildcard&gt;/.../&lt;last_wildcard&gt;.bmk</code></pre>
</section>
<section id="some-additional-snakemake-topics" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="some-additional-snakemake-topics"><span class="header-section-number">13.4</span> Some additional snakemake topics</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../nmfs-bioinf/snakemake-relevant-python.html" class="pagination-link" aria-label="Snakemake-relevant Python for R Users">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Snakemake-relevant Python for R Users</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../nmfs-bioinf/variant-calling.html" class="pagination-link" aria-label="Variant calling">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Variant calling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/eriqande/con-gen-csu/edit/main/nmfs-bioinf/snakemake-embellishments.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/eriqande/con-gen-csu/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>