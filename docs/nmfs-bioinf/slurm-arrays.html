<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>con-gen-csu - 7&nbsp; Slurm Job Arrays</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../nmfs-bioinf/sequence-alignment.html" rel="next">
<link href="../nmfs-bioinf/sbatch.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../nmfs-bioinf/slurm-arrays.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../nmfs-bioinf/quarto-static/fisheries_header_logo_jul2019.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">con-gen-csu</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/quick-unix-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Quick Unix Review</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/shell-prog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Shell Programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/awk-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Brief <code>awk</code> Intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/scripts-and-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Bash scripts and functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Sedna and SLURM intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sbatch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Submitting jobs with <code>sbatch</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm-arrays.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sequence-alignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Sequence alignment and handling BAM files</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/bioinf-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bioinformatic file formats</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snake.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Snakemake Narrative and Topics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snakemake-relevant-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Snakemake-relevant Python for R Users</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#prepare-for-this-session" id="toc-prepare-for-this-session" class="nav-link active" data-scroll-target="#prepare-for-this-session"><span class="header-section-number">7.1</span> Prepare for this session</a></li>
  <li><a href="#sbatchs---array-option" id="toc-sbatchs---array-option" class="nav-link" data-scroll-target="#sbatchs---array-option"><span class="header-section-number">7.2</span> <code>sbatch</code>’s <code>--array</code> option</a></li>
  <li><a href="#variations-on-the-array_spec" id="toc-variations-on-the-array_spec" class="nav-link" data-scroll-target="#variations-on-the-array_spec"><span class="header-section-number">7.3</span> Variations on the <code>&lt;array_spec&gt;</code></a></li>
  <li><a href="#translating-array-indexes-to-job-instances" id="toc-translating-array-indexes-to-job-instances" class="nav-link" data-scroll-target="#translating-array-indexes-to-job-instances"><span class="header-section-number">7.4</span> Translating Array Indexes to Job Instances</a>
  <ul class="collapse">
  <li><a href="#an-example-tab-delimited-file" id="toc-an-example-tab-delimited-file" class="nav-link" data-scroll-target="#an-example-tab-delimited-file"><span class="header-section-number">7.4.1</span> An example TAB-delimited file</a></li>
  <li><a href="#the-line-assign.sh-script" id="toc-the-line-assign.sh-script" class="nav-link" data-scroll-target="#the-line-assign.sh-script"><span class="header-section-number">7.4.2</span> The <code>line-assign.sh</code> script</a></li>
  </ul></li>
  <li><a href="#putting-it-all-together-a-read-mapping-job-array" id="toc-putting-it-all-together-a-read-mapping-job-array" class="nav-link" data-scroll-target="#putting-it-all-together-a-read-mapping-job-array"><span class="header-section-number">7.5</span> Putting it all together: a read-mapping job array</a></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up"><span class="header-section-number">7.6</span> Wrap Up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="slurm-arrays" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<ul>
<li>The <code>sbatch</code> command takes an <code>--array=&lt;array_spec&gt;</code> option that let’s you quickly launch—and easily manage—different instances of a single job that are all differentiated by a unique integer.</li>
<li>That integer is accessible within the script as the environment variable <code>SLURM_ARRAY_TASK_ID</code>.</li>
<li>We will see a little shell/awk script that is very helpful in this context.</li>
</ul>
<section id="prepare-for-this-session" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="prepare-for-this-session"><span class="header-section-number">7.1</span> Prepare for this session</h2>
<p>Get on your cluster and navigate to the top level (<code>con-gen-csu</code>) of your fork of the class repository. Then, to make sure that you have all the latest updates from the repository, sync the main branch of your fork with the main branch of <code>eriqande/con-gen-csu</code> on GitHub, then in your shell, use <code>git switch main</code> to make sure you are on the main branch of your fork, and then use <code>git pull origin main</code> to pull down those changes.</p>
</section>
<section id="sbatchs---array-option" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="sbatchs---array-option"><span class="header-section-number">7.2</span> <code>sbatch</code>’s <code>--array</code> option</h2>
<p>When you give <code>sbatch</code> the <code>--array=1-10</code> option, say, then it runs your job 10 separate times, each time with the environment variable <code>SLURM_ARRAY_TASK_ID</code> set to a different number between 1 and 10.</p>
<p>Let’s see a quick example, using the following script:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/array_example.sh</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=00:05:00</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=my_output_%A_%a</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=my_error_%A_%a</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-10</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ODIR<span class="ot">=</span>results<span class="sc">/</span>array_example</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>mkdir <span class="sc">-</span>p <span class="sc">$</span>ODIR</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"The SLURM_ARRAY_JOB_ID is : $SLURM_ARRAY_JOB_ID"</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"The SLURM_ARRAY_TASK_ID is: $SLURM_ARRAY_TASK_ID"</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"The SLURM_JOB_ID is: $SLURM_JOB_ID"</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  echo</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  echo <span class="st">"You can refer to this individual SLURM array task as: ${SLURM_ARRAY_JOB_ID}_${SLURM_ARRAY_TASK_ID}"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  echo</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">&gt;</span> <span class="er">$</span>ODIR<span class="sc">/</span>output_<span class="sc">$</span>SLURM_ARRAY_TASK_ID.txt</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>sleep <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>This is helpful to see a few of the variables that are defined in the environment of an array job:</p>
<ul>
<li><code>SLURM_ARRAY_JOB_ID</code>: the overall JOB_ID for the whole array</li>
<li><code>SLURM_ARRAY_TASK_ID</code>: the index that runs from 1 to 10 in this case</li>
<li><code>SLURM_JOB_ID</code>: The underlying job_id</li>
</ul>
<p>One can run this script, but we don’t want a whole classroom full of people throwing all these jobs on the cluster. So, get into groups of three or four, talk amongst yourselves about what you think this script will do, and then have just one person from each group launch the job with the following command:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>One person from each group, paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="One person from each group, paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> scripts/array_example.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then use <code>myjobs</code> and <code>alljobs</code> to watch what is happening on the cluster.</p>
<p>When that job is done, or when it is running, look at the values written to the first output files:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into you shell</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="Paste this into you shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> results/array_example/output_{1..10}.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Cool syntax interlude: <code>{1..10}</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>On the shell, if you do something like:</p>
<ul>
<li><code>{2..7}</code>: that will expand to <code>2 3 4 5 6 7</code></li>
<li><code>{a..g}</code>: that will expand to <code>a b c d e f g</code></li>
<li><code>{0001..0015}</code>: that will expand to <code>0001 0002 0003 0004 0005 0006 0007 0008 0009 0010 0011 0012 0013 0014 0015</code></li>
<li><code>{F..M}</code>: that will expand to <code>F G H I J K L M</code></li>
</ul>
</div>
</div>
</div>
<p>From looking at the array_example output files, we can infer that:</p>
<ul>
<li><code>SLURM_ARRAY_JOB_ID</code>: is a unique number that refers to the <em>entire set</em> of jobs in the array</li>
<li><code>SLURM_ARRAY_TASK_ID</code>: is the integer that is being cycled over in the array job</li>
<li><code>SLURM_JOB_ID</code>: is a unique SLURM_JOB_ID of the specific array task.</li>
</ul>
<p>Also, in <code>alljobs</code> and <code>myjobs</code> you see that jobs can be referred to like <code>331989_4</code>. That is <code>SLURM_ARRAY_JOB_ID</code> + underscore + <code>SLURM_ARRAY_TASK_ID</code>. For example: <code>scancel 376578_12</code>.</p>
<p>In the slurm output files specified like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">SBATCH</span> <span class="at">--output</span><span class="op">=</span>my_output_%A_%a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>%A</code> expands to <code>SLURM_ARRAY_JOB_ID</code></li>
<li><code>%a</code> expands to <code>SLURM_ARRAY_TASK_ID</code></li>
</ul>
<p>If you need to cancel a particular array task using <code>scancel</code> you would typically use <code>SLURM_ARRAY_JOB_ID</code> + underscore + <code>SLURM_ARRAY_TASK_ID</code>, unless you wanted to cancel all remaining instances of an array task, in which case you would use</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> SLURM_ARRAY_JOB_ID</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="variations-on-the-array_spec" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="variations-on-the-array_spec"><span class="header-section-number">7.3</span> Variations on the <code>&lt;array_spec&gt;</code></h2>
<p>There are some important variations to how you can specify those array numbers:</p>
<ul>
<li><code>--array=1-50</code>: simple, consecutive numbers</li>
<li><code>--array=1-10:3</code>: 1 through 10 by threes, (so <code>1,4,7,10</code>)</li>
<li><code>--array=1,2,3,6,9,15</code> non-consecutive numbers</li>
<li><code>--array=1-21:10,100-200:50</code>: non-consecutive ranges. It becomes (<code>1,11,21,100,150,200</code>)</li>
<li><code>--array=1-10,4</code>: WARNING, this becomes <code>1,2,3,4,5,6,7,8,9,10,4</code>. SLURM does not check that the array numbers are unique, so task array 4 would be run twice (possibly concurrently overwriting the output.)</li>
<li><code>--array=1-20%5</code> VERY IMPORTANT SYNTAX: Run the jobs, but don’t ever have more the 5 running at a time. This is useful for making sure your jobs don’t consume every last CPU on Sedna.</li>
</ul>
<p>Let’s try putting all these together. Read the following command and, talking among the members of your group, figure out what the array spec is doing. Then have one person from each group submit the job with the following command:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>One person from each group, aste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="One person from each group, aste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>100,200,300-400:10%5 scripts/array_example.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then use <code>myjobs</code> and <code>alljobs</code> to see what is going on in the cluster.</p>
<p>Do you ever have more than 5 jobs running?</p>
</section>
<section id="translating-array-indexes-to-job-instances" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="translating-array-indexes-to-job-instances"><span class="header-section-number">7.4</span> Translating Array Indexes to Job Instances</h2>
<ul>
<li>The user is left to translate what a job array index of, say, 7, means in terms of what actions that array task should take.</li>
<li>Quite often you will want to map an array index to a different file to analyze, or perhaps a different region of a chromosome to do variant calling on, etc.</li>
<li>A flexible and generic way of doing this mapping from array indexes to job specifics is to first define the variables (things like filenames, etc.) required by each array task in a simple TAB-delimited text file in which the first row holds the names of the variables in different TAB-separated columns, and each row below that holds the values that those variables should take for different values of the array index.</li>
<li>The array index itself should be listed in the first column, whose name is <code>index</code>.</li>
</ul>
<section id="an-example-tab-delimited-file" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="an-example-tab-delimited-file"><span class="header-section-number">7.4.1</span> An example TAB-delimited file</h3>
<p>Let’s explore the following file, which is at <code>data/sample-array-info.tsv</code>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of data/sample-array-info.tsv</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span>   sample  library flowcell    platform    lane    barcode fq1 fq2</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1</span>   DPCh_plate1_B10_S22 plate1  HTYYCBBXX   ILLUMINA    1   GACGTCAT+TCAACTGG   data/fastqs/DPCh_plate1_B10_S22_R1.fq.gz    data/fastqs/DPCh_plate1_B10_S22_R2.fq.gz</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span>   DPCh_plate1_B11_S23 plate1  HTYYCBBXX   ILLUMINA    1   CCGCTTAA+ACGATGAC   data/fastqs/DPCh_plate1_B11_S23_R1.fq.gz    data/fastqs/DPCh_plate1_B11_S23_R2.fq.gz</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span>   DPCh_plate1_B12_S24 plate1  HTYYCBBXX   ILLUMINA    1   GACGAACT+TCGCATTG   data/fastqs/DPCh_plate1_B12_S24_R1.fq.gz    data/fastqs/DPCh_plate1_B12_S24_R2.fq.gz</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">4</span>   DPCh_plate1_C10_S34 plate1  HTYYCBBXX   ILLUMINA    1   AGTCACAT+CCATAATG   data/fastqs/DPCh_plate1_C10_S34_R1.fq.gz    data/fastqs/DPCh_plate1_C10_S34_R2.fq.gz</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">5</span>   DPCh_plate1_C11_S35 plate1  HTYYCBBXX   ILLUMINA    1   CCTTTCAC+AAACAAGA   data/fastqs/DPCh_plate1_C11_S35_R1.fq.gz    data/fastqs/DPCh_plate1_C11_S35_R2.fq.gz</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">6</span>   DPCh_plate1_C12_S36 plate1  HTYYCBBXX   ILLUMINA    1   GCACACAA+TCGTCAAG   data/fastqs/DPCh_plate1_C12_S36_R1.fq.gz    data/fastqs/DPCh_plate1_C12_S36_R2.fq.gz</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">7</span>   DPCh_plate1_D09_S45 plate1  HTYYCBBXX   ILLUMINA    1   CTTTCCCT+AGTAAGCC   data/fastqs/DPCh_plate1_D09_S45_R1.fq.gz    data/fastqs/DPCh_plate1_D09_S45_R2.fq.gz</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">8</span>   DPCh_plate1_D11_S47 plate1  HTYYCBBXX   ILLUMINA    1   GACAATTC+CATATCGT   data/fastqs/DPCh_plate1_D11_S47_R1.fq.gz    data/fastqs/DPCh_plate1_D11_S47_R2.fq.gz</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ex">9</span>   DPCh_plate1_F10_S70 plate1  HTYYCBBXX   ILLUMINA    1   ACACGACT+CTGCGGAT   data/fastqs/DPCh_plate1_F10_S70_R1.fq.gz    data/fastqs/DPCh_plate1_F10_S70_R2.fq.gz</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">10</span>  DPCh_plate1_F11_S71 plate1  HTYYCBBXX   ILLUMINA    1   TCCACGTT+GTTCAACC   data/fastqs/DPCh_plate1_F11_S71_R1.fq.gz    data/fastqs/DPCh_plate1_F11_S71_R2.fq.gz</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ex">11</span>  DPCh_plate1_F12_S72 plate1  HTYYCBBXX   ILLUMINA    1   AACCAGAG+AACCGAAG   data/fastqs/DPCh_plate1_F12_S72_R1.fq.gz    data/fastqs/DPCh_plate1_F12_S72_R2.fq.gz</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ex">12</span>  DPCh_plate1_G09_S81 plate1  HTYYCBBXX   ILLUMINA    1   CGAATACG+GTCGGTAA   data/fastqs/DPCh_plate1_G09_S81_R1.fq.gz    data/fastqs/DPCh_plate1_G09_S81_R2.fq.gz</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ex">13</span>  DPCh_plate1_G10_S82 plate1  HTYYCBBXX   ILLUMINA    1   CAGTGCTT+ACCTGGAA   data/fastqs/DPCh_plate1_G10_S82_R1.fq.gz    data/fastqs/DPCh_plate1_G10_S82_R2.fq.gz</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ex">14</span>  DPCh_plate1_G12_S84 plate1  HTYYCBBXX   ILLUMINA    1   TCCATTGC+AGACCGTA   data/fastqs/DPCh_plate1_G12_S84_R1.fq.gz    data/fastqs/DPCh_plate1_G12_S84_R2.fq.gz</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="ex">15</span>  DPCh_plate1_H09_S93 plate1  HTYYCBBXX   ILLUMINA    1   GTCGATTG+ACGGTCTT   data/fastqs/DPCh_plate1_H09_S93_R1.fq.gz    data/fastqs/DPCh_plate1_H09_S93_R2.fq.gz</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="ex">16</span>  DPCh_plate1_H10_S94 plate1  HTYYCBBXX   ILLUMINA    1   ATAACGCC+TGAACCTG   data/fastqs/DPCh_plate1_H10_S94_R1.fq.gz    data/fastqs/DPCh_plate1_H10_S94_R2.fq.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>An easier way to view this might be to look at in on GitHub at: <a href="https://github.com/eriqande/con-gen-csu/blob/main/data/sample-array-info.tsv">here</a></p>
<p>Something that would be really handy would be a little shell script that would pick out a particular line of that file that corresponds to the value in the <code>index</code> column and then define some shell variables according to the columns names: <code>index</code>, <code>sample</code>, <code>library</code>, <code>flowcell</code>, <code>platform</code>, <code>lane</code>, <code>barcode</code>, <code>fq1</code>, <code>fq2</code> so that they could be used in an array script.</p>
<p>We have already seen some of the bash and <code>awk</code> machinery that would make that possible, and we have wrapped it up in the <code>line-assign.sh</code> script.</p>
</section>
<section id="the-line-assign.sh-script" class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="the-line-assign.sh-script"><span class="header-section-number">7.4.2</span> The <code>line-assign.sh</code> script</h3>
<p>Within the repository is a script called <code>scripts/line-assign.sh</code>, that looks like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/line-assign.sh</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># simple script.  Arguments are:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  1. The index to pick out (like 1, or 2, or 7, etc)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  2. Path to a TAB delimited file with the first column named index</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     and subsequent columns named valid shell variable names.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This script will pick out the line that matches $1, and return a command</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># line assigning the column header names as shell variables whose values are the</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># values in each cell in the file $2.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: this is not written with a whole lot of error checking or catching.</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">-ne</span> 2 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"Wrong number of arguments in </span><span class="va">$0</span><span class="st"> "</span> <span class="op">&gt;</span> /dev/stderr</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="at">-F</span><span class="st">"\t"</span> <span class="at">-v</span> LINE=<span class="va">$1</span> <span class="st">'</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="st">  $1 == "index" {for(i=1; i&lt;=NF; i++) vars[i]=$i; next}</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="st">  $1 == LINE {for(i=1; i&lt;=NF; i++) printf("%s=\"%s\"; ", vars[i], $i); printf("\n");}</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="st">'</span> <span class="va">$2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s see what sorts of results this produces:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">./scripts/line-assign.sh</span> 3 data/sample-array-info.tsv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whoa! It returns a command line that assigns values to a lot of shell variables.</p>
<p>So, if we wanted to run that command line, we would have to precede it with the <code>eval</code> keyword (because the command line itself includes special characters like <code>=</code>). Let’s do that like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="va">COMM</span><span class="op">=</span><span class="va">$(</span><span class="ex">./scripts/line-assign.sh</span> 3 data/sample-array-info.tsv<span class="va">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$COMM</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, that you have done that, you can see that a lot of variables have been assigned the values on the <code>index == 3</code> line of our TSV file:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"index:      </span><span class="va">$index</span><span class="st">"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"sample:     </span><span class="va">$sample</span><span class="st">"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"library:    </span><span class="va">$library</span><span class="st">"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"platform:   </span><span class="va">$platform</span><span class="st">"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"lane:       </span><span class="va">$lane</span><span class="st">"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"barcode:    </span><span class="va">$barcode</span><span class="st">"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"fq1:        </span><span class="va">$fq1</span><span class="st">"</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"fq2:        </span><span class="va">$fq2</span><span class="st">"</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Holy Smokes! These are variables that we could use in a job array script.</p>
<p>In this case, we can assign values to the pesky Read Group string for <code>bwa mem</code>.</p>
</section>
</section>
<section id="putting-it-all-together-a-read-mapping-job-array" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="putting-it-all-together-a-read-mapping-job-array"><span class="header-section-number">7.5</span> Putting it all together: a read-mapping job array</h2>
<p>We can now elaborate on our simple <code>bwa_map.sh</code> shell script and turn that into a SLURM job array script. The key here is that when SLURM runs the script as a slurm array, there will be an environment variable called <code>SLURM_ARRAY_TASK_ID</code> that we can use to pick out the desired sample from the <code>data/sample-array-info.tsv</code> file.</p>
<p>Here is what it looks like:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/bwa_map_array.sh</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=1:00:00</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=bwa_map_array-%A_%a.out</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=bwa_map_array-%A_%a.err</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-16</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># load the module that gives us the bwa software</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load bwa</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load samtools</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># make a directory for log output if it does not already exist</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="va">LDIR</span><span class="op">=</span>results/log/bwa_map_array</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="va">ODIR</span><span class="op">=</span>results/mapped</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$LDIR</span> <span class="va">$ODIR</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># get shell variables for this array task:</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="va">COMM</span><span class="op">=</span><span class="va">$(</span><span class="ex">./scripts/line-assign.sh</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> data/sample-array-info.tsv<span class="va">)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="va">$COMM</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># run bwa mem on the input and pipe it to samtools to sort it</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem <span class="dt">\</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">-R</span> <span class="st">"@RG\tID:</span><span class="va">${sample}</span><span class="st">.</span><span class="va">${library}</span><span class="st">.</span><span class="va">${flowcell}</span><span class="st">.</span><span class="va">${lane}</span><span class="st">\tSM:</span><span class="va">${sample}</span><span class="st">\tLB:</span><span class="va">${library}</span><span class="st">\tBC:</span><span class="va">${barcode}</span><span class="st">\tPU:\tID:</span><span class="va">${sample}</span><span class="st">.</span><span class="va">${library}</span><span class="st">.</span><span class="va">${flowcell}</span><span class="st">.</span><span class="va">${lane}</span><span class="st">.</span><span class="va">${barcode}</span><span class="st">\tPL:ILLUMINA"</span> <span class="dt">\</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  data/genome/genome.fasta <span class="dt">\</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="va">$fq1</span> <span class="va">$fq2</span>  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$LDIR</span>/bwa_mem_<span class="va">$sample</span>.log <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="ex">samtools</span> view <span class="at">-u</span> <span class="at">-</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="ex">samtools</span> sort <span class="at">-o</span> <span class="va">$ODIR</span>/<span class="va">$sample</span>.bam</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="kw">)</span> <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$LDIR</span>/samtools_<span class="va">$sample</span>.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The main differences from our simple <code>bwa_map.sh</code> script are:</p>
<ul>
<li>The <code>SLURM_ARRAY_TASK_ID</code> is used to pick out the right line from our TSV file of information</li>
<li>The slurm output and error have been changed to use <code>%A_%a</code> notation.</li>
<li>There is a <code>#SBATCH --array=1-16</code> directive, to run it over the 16 different files.</li>
<li>The shell code that runs <code>bwa</code> and <code>samtools</code> uses the variables that were defined by <code>eval</code>-ing the results of the call to the <code>line-assign.sh</code> script.</li>
</ul>
<p>You can launch that job array and see how it goes:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> scripts/bwa_map_array.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then check with <code>myjobs</code> and <code>alljobs</code> to see what is happening on Sedna.</p>
<p>That runs really fast.</p>
<p>Afterward you can check that the results exist:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb14" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-l</span> results/mapped</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And you can look at the logs for <code>bwa mem</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>  results/log/bwa_map_array/bwa_mem_<span class="pp">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To see what one of the output files looks like, you can use samtools. On Alpine, you have to get onto a compute node to do that, so you would first do:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Do this if you are on the Alpine cluster</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="Do this if you are on the Alpine cluster"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load slurm/alpine</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--partition</span><span class="op">=</span>atesting <span class="at">--pty</span> /bin/bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then do like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="Paste this into your shell"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load samtools</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view results/mapped/DPCh_plate1_F10_S70.bam <span class="kw">|</span> <span class="fu">less</span> <span class="at">-S</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the left and right arrows, and space bar and backspace to see all parts of the file.</p>
<p>Remember to hit <code>q</code> to get out of the <code>less</code> viewer.</p>
</section>
<section id="wrap-up" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="wrap-up"><span class="header-section-number">7.6</span> Wrap Up</h2>
<p>So, that was a quick tour of the capabilities of <code>sbatch</code>.</p>
<p>Oddly enough, I haven’t directly launched any jobs using <code>sbatch</code> (apart from the example jobs for this course) in many months, because I drive all my bioinformatics projects using Snakemake, which sends my jobs to SLURM for me.</p>
<p>Eventually we will have an introduction to Snakemake!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../nmfs-bioinf/sbatch.html" class="pagination-link" aria-label="Submitting jobs with `sbatch`">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Submitting jobs with <code>sbatch</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../nmfs-bioinf/sequence-alignment.html" class="pagination-link" aria-label="Sequence alignment and handling BAM files">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Sequence alignment and handling BAM files</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>