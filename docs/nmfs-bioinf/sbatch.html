<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>con-gen-csu - 6&nbsp; Submitting jobs with sbatch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../nmfs-bioinf/slurm-arrays.html" rel="next">
<link href="../nmfs-bioinf/slurm.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../nmfs-bioinf/sbatch.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Submitting jobs with `sbatch`</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../nmfs-bioinf/quarto-static/fisheries_header_logo_jul2019.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">con-gen-csu</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/quick-unix-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Quick Unix Review</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/shell-prog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Shell Programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/awk-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Brief <code>awk</code> Intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/scripts-and-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Bash scripts and functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Sedna and SLURM intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sbatch.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Submitting jobs with <code>sbatch</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/slurm-arrays.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/snake.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Snakemake Tutorial Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/bioinf-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bioinformatic file formats</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nmfs-bioinf/sequence-alignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Sequence alignment and handling BAM files</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#prepare-for-this-session" id="toc-prepare-for-this-session" class="nav-link active" data-scroll-target="#prepare-for-this-session"><span class="header-section-number">6.1</span> Prepare for this session</a></li>
  <li><a href="#the-sbatch-command-and-its-options" id="toc-the-sbatch-command-and-its-options" class="nav-link" data-scroll-target="#the-sbatch-command-and-its-options"><span class="header-section-number">6.2</span> The <code>sbatch</code> command and its options</a></li>
  <li><a href="#what-an-invocation-of-sbatch-could-look-like" id="toc-what-an-invocation-of-sbatch-could-look-like" class="nav-link" data-scroll-target="#what-an-invocation-of-sbatch-could-look-like"><span class="header-section-number">6.3</span> What an invocation of <code>sbatch</code> could look like</a></li>
  <li><a href="#storing-slurm-options-in-your-shell-script" id="toc-storing-slurm-options-in-your-shell-script" class="nav-link" data-scroll-target="#storing-slurm-options-in-your-shell-script"><span class="header-section-number">6.4</span> Storing SLURM options in your shell script</a></li>
  <li><a href="#let-us-submit-the-bwa_index.sh-job-to-slurm" id="toc-let-us-submit-the-bwa_index.sh-job-to-slurm" class="nav-link" data-scroll-target="#let-us-submit-the-bwa_index.sh-job-to-slurm"><span class="header-section-number">6.5</span> Let us submit the <code>bwa_index.sh</code> job to SLURM</a></li>
  <li><a href="#how-many-resources-did-that-job-use-seff" id="toc-how-many-resources-did-that-job-use-seff" class="nav-link" data-scroll-target="#how-many-resources-did-that-job-use-seff"><span class="header-section-number">6.6</span> How many resources did that job use? — <code>seff</code></a></li>
  <li><a href="#a-simple-job-with-default-sbatch-settings" id="toc-a-simple-job-with-default-sbatch-settings" class="nav-link" data-scroll-target="#a-simple-job-with-default-sbatch-settings"><span class="header-section-number">6.7</span> A simple job with default sbatch settings</a></li>
  <li><a href="#oh-no-i-need-to-stop-my-jobs-scancel" id="toc-oh-no-i-need-to-stop-my-jobs-scancel" class="nav-link" data-scroll-target="#oh-no-i-need-to-stop-my-jobs-scancel"><span class="header-section-number">6.8</span> Oh no! I need to stop my job(s): <code>scancel</code></a></li>
  <li><a href="#a-note-about-memory" id="toc-a-note-about-memory" class="nav-link" data-scroll-target="#a-note-about-memory"><span class="header-section-number">6.9</span> A note about memory</a></li>
  <li><a href="#what-happens-if-we-exceed-our-resources" id="toc-what-happens-if-we-exceed-our-resources" class="nav-link" data-scroll-target="#what-happens-if-we-exceed-our-resources"><span class="header-section-number">6.10</span> What happens if we exceed our resources?</a></li>
  <li><a href="#sbatch-options-on-the-command-line-will-override-the-sbatch-directives-in-the-file" id="toc-sbatch-options-on-the-command-line-will-override-the-sbatch-directives-in-the-file" class="nav-link" data-scroll-target="#sbatch-options-on-the-command-line-will-override-the-sbatch-directives-in-the-file"><span class="header-section-number">6.11</span> <code>sbatch</code> options on the command line will override the <code>#SBATCH</code> directives in the file</a></li>
  <li><a href="#lets-run-out-of-time" id="toc-lets-run-out-of-time" class="nav-link" data-scroll-target="#lets-run-out-of-time"><span class="header-section-number">6.12</span> Let’s run out of time</a></li>
  <li><a href="#a-major-gotcha-do-not-direct-sbatchs-output-or-error-to-a-path-that-does-not-exist" id="toc-a-major-gotcha-do-not-direct-sbatchs-output-or-error-to-a-path-that-does-not-exist" class="nav-link" data-scroll-target="#a-major-gotcha-do-not-direct-sbatchs-output-or-error-to-a-path-that-does-not-exist"><span class="header-section-number">6.13</span> A major gotcha: Do not direct <code>sbatch</code>’s <code>output</code> or <code>error</code> to a path that does not exist</a></li>
  <li><a href="#schedule-multiple-jobs-with-sbatch-using-a-for-loop" id="toc-schedule-multiple-jobs-with-sbatch-using-a-for-loop" class="nav-link" data-scroll-target="#schedule-multiple-jobs-with-sbatch-using-a-for-loop"><span class="header-section-number">6.14</span> Schedule multiple jobs with <code>sbatch</code> using a <code>for</code> loop</a></li>
  <li><a href="#final-thought" id="toc-final-thought" class="nav-link" data-scroll-target="#final-thought"><span class="header-section-number">6.15</span> Final thought</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sbatch" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Submitting jobs with <code>sbatch</code></span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<ul>
<li><p>Up till now we have allocated ourselves computing resources for <em>interactive</em> use.</p></li>
<li><p>This is what you would do if you were going to be doing computationally intensive things directly while hacking on the command line….</p></li>
<li><p>…or if you were going to start an R session and interactively work on some big data on it.</p></li>
<li><p>etc.</p></li>
</ul>
<p>Running an interactive shell on a compute node is also a great way to test your scripts.</p>
<p>However, once your scripts are tested, for most of your heavy computation, you will want to submit jobs as non-interactive <em>batch</em> jobs using SLURM’s <code>sbatch</code> command.</p>
<section id="prepare-for-this-session" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="prepare-for-this-session"><span class="header-section-number">6.1</span> Prepare for this session</h2>
<p>Get on your cluster and navigate to the top level (<code>con-gen-csu</code>) of your fork of the class repository. Then, to make sure that you have all the latest updates from the repository, sync the main branch of your fork with the main branch of <code>eriqande/con-gen-csu</code> on GitHub, then in your shell, use <code>git switch main</code> to make sure you are on the main branch of your fork, and then use <code>git pull origin main</code> to pull down those changes.</p>
</section>
<section id="the-sbatch-command-and-its-options" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="the-sbatch-command-and-its-options"><span class="header-section-number">6.2</span> The <code>sbatch</code> command and its options</h2>
<p>If you do <code>man sbatch</code> you will see an insanely large number of options and all sorts of complicated stuff.</p>
<p>You can get by with a fairly minimal set of options for almost everything you need to do. They are:</p>
<ul>
<li><code>--cpus-per-task=&lt;n&gt;</code>: the number of cores to use for the job. The syntax has you using it like this <code>--cpus-per-task=2</code>
<ul>
<li>On Sedna, the default is 1.</li>
</ul></li>
<li><code>--mem=&lt;size[units]&gt;</code>: How much total memory for the job. Example: <code>--mem=4G</code>
<ul>
<li>On Sedna, the default is about 4.7 Gb for each requested core.</li>
<li>On Alpine’s <code>amilan</code> partition, the machines have 3.74 Gb per core.</li>
</ul></li>
<li><code>--time=[D-]HH:MM:SS</code>: How much time are you requesting? You don’t have to specify days, so you could say, <code>--time=1-12:00:00</code> for one day and twelve hours, or you could say <code>--time=36:00:00</code> for 36 hours.
<ul>
<li>On Sedna, the default is 8 hours.</li>
</ul></li>
<li><code>--output=&lt;filename pattern&gt;</code>: Where should anything on <code>stdout</code> that is not otherwise redirected be written to?</li>
<li><code>--error=&lt;filename pattern&gt;</code>: Where should anything on <code>stderr</code> that is not otherwise redirected be written to?</li>
</ul>
<p>On top of the options, <code>sbatch</code> takes a single required argument, which must be the path to a shell script (we know about those!) that the job will run.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fun fact:
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you pass any arguments after the name of the shell script that you want <code>sbatch</code> to execute, those are interpreted as arguments to the shell script itself.</p>
</div>
</div>
</section>
<section id="what-an-invocation-of-sbatch-could-look-like" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="what-an-invocation-of-sbatch-could-look-like"><span class="header-section-number">6.3</span> What an invocation of <code>sbatch</code> could look like</h2>
<p>So, if we wanted to schedule a script called <code>MyScript.sh</code> to run with 4 cores and memory of 80Gb, with an allowance of 16 hours, and we wanted to tell SLURM where to capture any otherwise un-redirected <code>stdout</code> and <code>stderr</code>, we would type something like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Don't bother copying or pasting this.</strong></pre>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--mem</span><span class="op">=</span>80G <span class="at">--time</span><span class="op">=</span>16:00:00 <span class="at">--output</span><span class="op">=</span>myscript_stdout <span class="at">--error</span><span class="op">=</span>myscript_error MyScript.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some points about that:</p>
<ul>
<li>Typing all of that is a huge hassle.</li>
<li>Most of the options will be specific to the actual job in <code>MyScript.sh</code></li>
</ul>
<p>So…<code>sbatch</code> allows you to store the options in your shell script on lines after the shebang line that are preceded by <code>#SBATCH</code>.</p>
</section>
<section id="storing-slurm-options-in-your-shell-script" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="storing-slurm-options-in-your-shell-script"><span class="header-section-number">6.4</span> Storing SLURM options in your shell script</h2>
<p>Let’s look at an example like one might do in an sbatch script:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/bwa_index.sh</strong></pre>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=2:00:00</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=3G</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=bwa_index-%j.out</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=bwa_index-%j.err</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a little script to index the genome given</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># by the first positional parameter ($1)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># load the module that gives us the bwa software</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load bwa</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># make a directory for log output if it does not already exist</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="va">DIR</span><span class="op">=</span>results/log/bwa_index</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$DIR</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># run bwa index on the input</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> index <span class="va">$1</span> <span class="op">&gt;</span> <span class="va">$DIR</span>/log.txt <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What’s that %j in the output and error options?
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the above script, you will see</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=bwa_index-%j.out</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=bwa_index-%j.err</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this context, the <code>%j</code> gets replaced by <code>sbatch</code> with the <code>SLURM_JOB_ID</code>.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Get email from SLURM.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>One useful feature of SLURM—especially if you are running just a few long jobs—is that you can tell it to send you email whenever some event occurs related to a job (like it Starts, or Finishes, or Fails).</p>
<p>The SBATCH directives for that look like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=myemail@emailserver.com</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=ALL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where you would replace <code>myemail@emailserver.com</code> with your own email address.</p>
<p>Note that option <code>--mail-type</code> can be tailored to modulate how much email you will get from SLURM.</p>
<p>TBH, though, I don’t have SLURM email any news about my jobs anymore. Workflows that are optimized into a lot of smaller jobs would fill your inbox pretty quickly!</p>
</div>
</div>
</div>
</section>
<section id="let-us-submit-the-bwa_index.sh-job-to-slurm" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="let-us-submit-the-bwa_index.sh-job-to-slurm"><span class="header-section-number">6.5</span> Let us submit the <code>bwa_index.sh</code> job to SLURM</h2>
<p>Since all of the <code>sbatch</code> options are imbedded within the shell script it is easy to write the command to launch the script.</p>
<p>Let’s prepare for that first. If you are on Alpine, make sure the slurm module is loaded.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>If you are working on Alpine, be sure to paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load slurm/alpine</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that you do <strong>not</strong> need to be on a compute node to submit a job via <code>sbatch</code>—you can do that from a login node.</p>
<p>To launch the script using <code>sbatch</code>, all you do is:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell at the top level of the con-gen-csu repo</strong></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> scripts/bwa_index.sh data/genome/genome.fasta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first argument is the script <code>scripts/bwa_index.sh</code> and the second, <code>resources/genome.fasta</code>, is the path to the genome that we want to index with <code>bwa</code>.</p>
<p>When this command executes, it returns the <code>SLURM_JOB_ID</code>. Make a note of it.</p>
<p>Once you have launched the job, try using <code>myjobs</code> to see your job running. (You don’t have much time, because it doesn’t take very long).</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hey! That job ran in the current working directory
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Note that our script ran <code>bwa index</code> by passing it the path of a reference genome specified as a <em>relative path</em>: the path was relative to our current working directory.</p>
<p>One of the wonderful features of SLURM is that, when <code>sbatch</code> runs your script, it does so from the current working directory of the shell in which you ran <code>sbatch</code>.</p>
<p>(I mention this because the first cluster I used was set up differently, and you had to explicitly tell it to run from the current working directory—which was the source of endless gnashing of teeth)</p>
</div>
</div>
</div>
<p>Once that job is done, use <code>ls -lrt data/genome</code> to see all the files that were newly created by the <code>bwa-index.sh</code> script.</p>
</section>
<section id="how-many-resources-did-that-job-use-seff" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="how-many-resources-did-that-job-use-seff"><span class="header-section-number">6.6</span> How many resources did that job use? — <code>seff</code></h2>
<p>When you first start doing bioinformatics, you will not be very familiar with how long each job will run, or how much memory it will need.</p>
<p>That takes some time, but one helpful utility, <code>seff</code>, will tell you the effective usage of the allocated resources by any <em>completed</em> job.</p>
<p>It’s simple to use:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Here is the sytnax</strong></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> slurm-jobid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Self-study
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try that command, <code>seff slurm-jobid</code>, replacing <code>slurm-jobid</code> with the actual <code>SLURM_JOB_ID</code> of the job that you just ran.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More tips on learning about past job resource use
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can also use the <code>sacct</code> command. Check it out with <code>man sacct</code>.</p>
<p>You can get information much like <code>seff</code> for your recent jobs with <code>sacct</code> and it is somewhat easier to look at all the jobs that have run (or are running) in the last 12 to 48 hours with it. So, here we define a function to use it easily, and also we can give it more space to print the job names:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell to get a myacct function</strong></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> myacct</span> <span class="kw">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="va">$#</span> <span class="ot">-ne</span> 1 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">JL</span><span class="op">=</span>10<span class="kw">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">JL</span><span class="op">=</span><span class="va">$1</span><span class="kw">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span><span class="kw">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">sacct</span>  <span class="at">--format</span> JobID,JobName%<span class="va">${JL}</span>,User,Group,State%20,Cluster,AllocCPUS,REQMEM,TotalCPU,Elapsed,MaxRSS,ExitCode,NNodes,NTasks <span class="at">-u</span> <span class="va">$(</span><span class="fu">whoami</span><span class="va">)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you like being able to use this, you ought to add it to your <code>~/.bashrc</code> file.</p>
</div>
</div>
</section>
<section id="a-simple-job-with-default-sbatch-settings" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="a-simple-job-with-default-sbatch-settings"><span class="header-section-number">6.7</span> A simple job with default sbatch settings</h2>
<p>We jumped right into talking about all the most useful options for <code>sbatch</code>.</p>
<p>However, on Sedna (and, indeed, on most clusters), SLURM defines reasonable defaults for an <code>sbatch</code> job.</p>
<p>It even sends the <code>output</code> and <code>error</code> to reasonably named files, as we shall see.</p>
<p>The following lists the contents of a script called <code>simple-15.sh</code> that doesn’t do much:</p>
<ol type="1">
<li>It writes out the SLURM_JOB_ID to <code>stdout</code></li>
<li>It writes a message to <code>stderr</code></li>
<li>Then it just sits there for 15 minutes.</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/simple-15.sh</strong></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"(stdout) Running with Slurm Job ID: </span><span class="va">$SLURM_JOB_ID</span><span class="st">"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"(stdout) Note that we are running this thing through"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"(stdout) the tee utility to try to unbuffer it."</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">)</span> <span class="kw">|</span> <span class="fu">tee</span> simple-15.stdout</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"(stderr) This line is being written to stderr"</span> <span class="op">&gt;</span> /dev/stderr</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"(stderr) Interestingly, stderr does not seem to get buffered."</span> <span class="op">&gt;&gt;</span> /dev/stderr</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span> 900</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Scripts running under SLURM have access to <code>SLURM_*</code> environment variables
</div>
</div>
<div class="callout-body-container callout-body">
<p>When a job is run by SLURM, it is done so in a shell environment that has a number of extra shell variables defined. In the above, we print the value of one of those: <code>SLURM_JOB_ID</code>.</p>
</div>
</div>
<p>Now we will submit that script to run as a SLURM job with:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> scripts/simple-15.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, use <code>myjobs</code> to see how many cores this job is using (1) and how much memory (4700 Mb on Sedna, 3840 on Alpine). Those are the default values.</p>
<p>By default, on some systems both <code>stdout</code> and <code>stderr</code> get written to <code>slurm-%j.out</code> (where <code>%j%</code> is replaced with the SLURM_JOB_ID).</p>
<p>You can see that is in that by doing:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Type this, but replace 331979 with whathever your actual SLURM job id is</strong></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> slurm-331979.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that <code>stderr</code> gets written to <code>slurm-%j.out</code> immediately. The <code>stdout</code> stream is supposed to get written there, as well, but it seems that there is some hard-core buffering that goes on with slurm: we can see the output in <code>simple-15.stdout</code>, but not in <code>slurm-%j.out</code>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Don’t leave <code>stdout</code> and <code>stderr</code> un-redirected in your scripts
</div>
</div>
<div class="callout-body-container callout-body">
<p>Seeing the buffering issues above hardens my own convictions that you should not rely on SLURM to capture any output to <code>stdout</code> or <code>stderr</code> that is not otherwise redirected to a file. You should always be explicit about redirecting <code>stdout</code> or <code>stderr</code> within your own scripts to files where we want it to go.</p>
<p>That way the slurm output logs are left to mostly capture messages from SLURM itself (for example, telling you that you ran out of memory or the job was cancelled.)</p>
</div>
</div>
</section>
<section id="oh-no-i-need-to-stop-my-jobs-scancel" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="oh-no-i-need-to-stop-my-jobs-scancel"><span class="header-section-number">6.8</span> Oh no! I need to stop my job(s): <code>scancel</code></h2>
<p>Now, we have a job that is sitting around doing nothing for the next 15 minutes or so.</p>
<p>This is a great time to talk about how to abort jobs that are running under <code>sbatch</code>:</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Cancelling jobs started with <code>sbatch</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you have the job number (which is returned when <code>sbatch</code> launched the job or which you can see on the corresponding line of <code>myjobs</code>) you can use <code>scancel</code> followed by the job number.</p>
<p>For example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 329656</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>…but you have to replace the number above with your job’s job number.</p>
<p>Please do that now!</p>
</div>
</div>
</section>
<section id="a-note-about-memory" class="level2" data-number="6.9">
<h2 data-number="6.9" class="anchored" data-anchor-id="a-note-about-memory"><span class="header-section-number">6.9</span> A note about memory</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Memory gets allocated with cores or via <code>--mem</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is quite clear that the <code>--mem</code> option to <code>sbatch</code> is intended to increase the memory allocated to the job; however adding cores with <code>--cpus-per-task</code>, without adding any options to dictate memory use, also increases the memory available.</p>
<p>On Sedna’s standard compute nodes, which each have 20 cores, if you ask for <span class="math inline">\(x\)</span> cores, the total amount of memory your job will get is about <span class="math inline">\(\frac{x}{20} T\)</span>, where <span class="math inline">\(T\)</span> is a little less than the total memory on the machine.</p>
<p>On the standard memory compute nodes, that means your job gets roughly 4700 Mb (4.7 Gb) of RAM for each <em>core</em> that it is allocated. (9400 Mb or 9.4 Gb for each core on the “higher-memory” standard compute nodes, <code>node[29-36]</code>)</p>
<p>Note, however, that if the programs running in your job are not multithreaded, then you might not be able to use all those cores. In which case, it might be better to specify additional memory allocation with <code>--mem</code>, and leave the other cores to other users.</p>
<p>However, on Alpine, if you ask for 3.74 Gb * 10 = 37.4 Gb of memory and only one core for computing, you will still be “charged” (i.e., you will run through your quota) as if you were using 10 cores! (i.e., billing is by the core, and you are charged for the number of cores that would give you a certain amount of memory).</p>
</div>
</div>
</section>
<section id="what-happens-if-we-exceed-our-resources" class="level2" data-number="6.10">
<h2 data-number="6.10" class="anchored" data-anchor-id="what-happens-if-we-exceed-our-resources"><span class="header-section-number">6.10</span> What happens if we exceed our resources?</h2>
<p>R uses 8 bytes for each numeric value it stores in a vector. But it also seems to do some fancy stuff with delayed evaluation, etc. So it is hard to know exactly how much system RAM R’s process will use.</p>
<p>Nonetheless, I have found that the following R commands will exceed 4700 Mb of RAM:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fl">1e9</span>); y <span class="ot">&lt;-</span> x <span class="sc">+</span> <span class="dv">1</span>; y[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Somewhere in the <code>y &lt;- x + 1</code> command, memory usage will exceed the default 4700 Mb (4.7 Gb) of RAM that SLURM allows by default (on SEDNA) or the 3.74 Gb of RAM allowed on Alpine.</p>
<p>So, what we are going to do here is run those commands in an <code>sbatch</code> script and see what happens. (You will probably exceed your allocated memory while doing bioinformatics, so you might as well get used to what that looks like.)</p>
<p>Here is a listing of a shell script to run under <code>sbatch</code> to exceed our memory usage:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of scripts/r-too-much-mem.sh</strong></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=2:00:00</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=r-too-much-mem-%j.out</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=r-too-much-mem-%j.err</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> outputs</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="va">EDIR</span><span class="op">=</span>results/log/r-too-much-mem</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$EDIR</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">--vanilla</span> <span class="at">-e</span> <span class="st">"x &lt;- runif(1e9); y &lt;- x + 1; y[1:10]"</span> <span class="op">&gt;</span> outputs/r-too-much.out <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$EDIR</span>/log.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Run it like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> scripts/r-too-much-mem.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It takes about a minute before it runs out of memory. During the time, check that it is still running using <code>myjobs</code>.</p>
<p>Once you see it is no longer running, check on the status of that job using <code>myacct 15</code>. The bottom line of output should show the results for that last job:</p>
<ul>
<li>The <code>State</code> column will show <code>OUT_OF_MEMORY</code></li>
<li>The <code>MaxRSS</code> column shows how much memory it used before failing. In my case, that was <code>4805260K</code>.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Self study
</div>
</div>
<div class="callout-body-container callout-body">
<p>How would you modify the <code>scripts/r-too-much-mem.sh</code> so that it did not run out of memory?</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Self study answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You need to allocate more memory to the job. You can do this by adding an sbatch directive line like:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=12G</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>amongst all the other sbatch directives. I don’t know if 12G of ram will be enough, but it might be. You could try it.</p>
<p><strong>OR</strong> as we will see below, you could add that memory option on the command line.</p>
</div>
</div>
</div>
</section>
<section id="sbatch-options-on-the-command-line-will-override-the-sbatch-directives-in-the-file" class="level2" data-number="6.11">
<h2 data-number="6.11" class="anchored" data-anchor-id="sbatch-options-on-the-command-line-will-override-the-sbatch-directives-in-the-file"><span class="header-section-number">6.11</span> <code>sbatch</code> options on the command line will override the <code>#SBATCH</code> directives in the file</h2>
<p>You can mix and match <code>sbatch</code> options on the command line with <code>sbatch</code> options in the <code>#SBATCH</code> directives in the script.</p>
<p><strong>The option on the command line takes precedence over the same option in the file.</strong></p>
<p>So, we could provide sufficient memory to <code>scripts/r-too-much-mem.sh</code> and at the same time, override the time it is allotted with this command:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Don't paste this into your shell---it uses too much resources</strong></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--mem</span><span class="op">=</span>16G <span class="at">--time</span><span class="op">=</span>01:00:00 scripts/r-too-much-mem.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you launched that job, you could use your <code>myjobs</code> function to see that the <code>MIN_MEMORY</code> is <code>16G</code> and the <code>TIME_LIMIT</code> is 1 hour.</p>
<p>When it finished you could run <code>myacct</code> to see that it successfully completed, and look in the output file <code>outputs/r-too-much.out</code> to see that it printed the first 10 of one billion random numbers with 1 added to them.</p>
</section>
<section id="lets-run-out-of-time" class="level2" data-number="6.12">
<h2 data-number="6.12" class="anchored" data-anchor-id="lets-run-out-of-time"><span class="header-section-number">6.12</span> Let’s run out of time</h2>
<p>We are going to rerun our <code>simple-15.sh</code> script, but only allocate one minute for it. So we should see it fail after only 1 minute.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Eric, why are making us run so many jobs that fail?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Let’s be honest, as you embark on your bioinformatic career with SLURM, you are going to spend a significant amount of your time dealing with jobs that fail.</p>
<p>You might as well see jobs failing in several different ways so that you can recognize them when you see them later.</p>
</div>
</div>
</div>
<p>So, try this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--time</span><span class="op">=</span>00:01:00 scripts/simple-15.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That will fail in a minute, after which, use <code>myacct</code> to see what it says about how it failed.</p>
<p>It will tell you that the main script hit a <code>TIMEOUT</code> and the batch job running in that script was <code>CANCELLED</code></p>
</section>
<section id="a-major-gotcha-do-not-direct-sbatchs-output-or-error-to-a-path-that-does-not-exist" class="level2" data-number="6.13">
<h2 data-number="6.13" class="anchored" data-anchor-id="a-major-gotcha-do-not-direct-sbatchs-output-or-error-to-a-path-that-does-not-exist"><span class="header-section-number">6.13</span> A major gotcha: Do not direct <code>sbatch</code>’s <code>output</code> or <code>error</code> to a path that does not exist</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Beware!
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you try something like:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH output=outputs/mydir/outfile.txt</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH error=outputs/mydir/errfile.txt</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but do so without having actually made the directory <code>outputs/mydir</code>, then <code>sbatch</code> will fail, and it won’t be able to write out why it failed.</p>
<p>This is dynamite. If you ever find that your <code>sbatch</code> jobs are failing immediately but with no reasonable error messages anywhere, check to make sure that you aren’t sending SLURM’s <code>output</code> or <code>error</code> to a directory that does not exist.</p>
<p>Note that you <em>cannot</em> make <code>outputs/mydir</code> within your script, because SLURM needs those directories before your script even gets executed.</p>
</div>
</div>
</section>
<section id="schedule-multiple-jobs-with-sbatch-using-a-for-loop" class="level2" data-number="6.14">
<h2 data-number="6.14" class="anchored" data-anchor-id="schedule-multiple-jobs-with-sbatch-using-a-for-loop"><span class="header-section-number">6.14</span> Schedule multiple jobs with <code>sbatch</code> using a <code>for</code> loop</h2>
<p>We now consider a small job of mapping some paired end reads to the genome that we indexed a few steps ago.</p>
<p>Let’s review the shell code in <code>scripts/bwa-map.sh</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Contents of file scripts/bwa_map.sh</strong></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=1:00:00</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=bwa_map-%j.out</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=bwa_map-%j.err</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a little script to map a pair of fastq files</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># that are in data/fastqs.</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The first positional parameter ($1)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># should be something like: DPCh_plate1_B10_S22</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># load the module that gives us the bwa software</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load bwa</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load samtools</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># make a directory for log output if it does not already exist</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="va">LDIR</span><span class="op">=</span>results/log/bwa_map</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="va">ODIR</span><span class="op">=</span>results/mapped</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$LDIR</span> <span class="va">$ODIR</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="va">SAMP</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># run bwa mem on the input and pipe it to samtools to sort it</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem data/genome/genome.fasta <span class="dt">\</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  data/fastqs/<span class="va">${SAMP}</span>_R1.fq.gz <span class="dt">\</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  data/fastqs/<span class="va">${SAMP}</span>_R2.fq.gz  <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$LDIR</span>/bwa_mem_<span class="va">${SAMP}</span>.log <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  <span class="ex">samtools</span> view <span class="at">-u</span> <span class="at">-</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="ex">samtools</span> sort <span class="at">-o</span> <span class="va">$ODIR</span>/<span class="va">$SAMP</span>.bam</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="kw">)</span> <span class="dv">2</span><span class="op">&gt;</span> <span class="va">$LDIR</span>/samtools_<span class="va">$SAMP</span>.log</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we are using backslashes (<code>\</code>) at the ends of the lines so that we can break a long line up onto separate lines of text.</p>
<p>Also note that grouping of commands by parentheses.</p>
<p>This script is run by passing it <code>DPCh_plate1_B10_S22</code>, <code>DPCh_plate1_B11_S23</code>, or <code>DPCh_plate1_B12_S24</code>, etc., as the first postitional parameter.</p>
<p>So, if we wanted to schedule three of those mapping jobs, we could do:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Paste this code into your shell</strong></pre>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> S <span class="kw">in</span> DPCh_plate1_B10_S22 DPCh_plate1_B11_S23 DPCh_plate1_B12_S24<span class="kw">;</span> <span class="cf">do</span> <span class="ex">sbatch</span> scripts/bwa_map.sh <span class="va">$S</span><span class="kw">;</span> <span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When that is done, check what is running with <code>myjobs</code> and <code>alljobs</code>. (But do it fast! Because these jobs finish very quickly).</p>
</section>
<section id="final-thought" class="level2" data-number="6.15">
<h2 data-number="6.15" class="anchored" data-anchor-id="final-thought"><span class="header-section-number">6.15</span> Final thought</h2>
<p>Though multiple jobs can be submitted via <code>sbatch</code> easily using this sort of <code>for</code> loop construct, there is another way of launching multiple repetitions of the same job in SLURM: using <em>job arrays</em></p>
<p>We will discuss that in the next section.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../nmfs-bioinf/slurm.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Sedna and SLURM intro</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../nmfs-bioinf/slurm-arrays.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Slurm Job Arrays</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>